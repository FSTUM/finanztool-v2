{% extends 'base.html' %}
{% load bootstrap5 %}

{% block title %}RE {{ rechnung.rnr_string }}{% endblock %}

{% block content %}
<h1>RE {{ rechnung.rnr_string }}: {{ rechnung.name }}
</h1>

{% if rechnung.gestellt and not rechnung.erledigt and rechnung.faellig %}
<a
    class="btn btn-danger"
    href="{% url "rechnung:mahnung_neu" rechnung.id %}"
><span class="bi bi-hourglass"></span> Mahnung stellen</a>
{% endif %}

<div class="row mt-3">
    {% if mahnungen %}
    <div class="col-lg-6">
        <h3>Mahnungen</h3>
        {% for mahnung in mahnungen %}
        <h4>
            <b>
                <a href="{% url 'rechnung:mahnung' rechnung.id mahnung.id %}">
                    {{ mahnung.wievielte }}. Mahnung
                </a>
            </b>
        </h4>
        <table class="table table-striped">
            <tr>
                <th>Mahngebühr <span class="bi bi-arrow-right"></span> Neue Summe</th>
                <td>{{ mahnung.gebuehr }} € <span class="bi bi-arrow-right"></span> <b> {{ mahnung.mahnsumme }}
                        €</b></td>
            </tr>
            <tr>
                <th>Gerichtliche Schritte</th>
                <td>
                    {% if mahnung.gerichtlich %}
                    <span style="color: red;">wurden angedroht.</span>
                    {% else %}
                    <span class="bi bi-dash-circle-fill"></span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Geschickt?</th>
                <td>
                    {% if mahnung.geschickt %}
                    <span class="bi bi-check-circle-fill"></span>
                    {% else %}
                    <span class="bi bi-person-x-fill"></span>
                    {% endif %}
                </td>
            <tr>
                <th>Bezahlt?</th>
                <td>
                    {% if mahnung.bezahlt %}
                    <span class="bi bi-check-circle-fill"></span>
                    {% else %}
                    <span class="bi bi-person-x-fill"></span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Datum, Fällig</th>
                <td>
                    {{ mahnung.mdatum }},
                    {% if mahnung.faellig and mahnung.geschickt %}
                    <span style="color: red;">
                        {% else %}
                        <span>
                            {% endif %}
                            {{ mahnung.mfdatum }}</span>
                </td>
            </tr>
            <tr>
                <th>Gestellt von</th>
                <td>{{ mahnung.ersteller.get_full_name }}</td>
            </tr>
            <tr>
                <th>Einleitung</th>
                <td>
                    {{ mahnung.einleitung }}
                </td>
            </tr>
        </table>
        {% endfor %}
    </div>
    {% endif %}

    <div class="col-lg-6">
        <h3>Übersicht
            <a
                class="btn btn-secondary"
                href="{% url "rechnung:rechnung_aendern" rechnung.id %}"
            >Bearbeiten</a>
        </h3>
        <br />
        <table class="table table-striped">
            <tr>
                <th>Rechnung gestellt?</th>
                <td>
                    {% if rechnung.gestellt %}
                    <span class="bi bi-check-circle-fill"></span>
                    {% else %}
                    <span class="bi bi-person-x-fill"></span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Rechnung erledigt?</th>
                <td>
                    {% if rechnung.bezahlt %}
                    <span style="color: green;">
                        <span class="bi bi-check-circle-fill"></span> Die Rechnung wurde bezahlt.
                    </span>
                    {% else %}
                    {% if rechnung.erledigt %}
                    <span style="color: green;">
                        <span class="bi bi-check-circle-fill"></span> Eine zugehörige Mahnung wurde bezahlt.
                    </span>
                    {% else %}
                    <span class="bi bi-person-x-fill"></span> Der Betrag ist noch offen
                    {% endif %}
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Kunde</th>
                <td>
                    <a href="{% url 'rechnung:kunde' rechnung.kunde.id %}">{{ rechnung.kunde }}</a>
                </td>
            </tr>
            <tr>
                <th>Rechnungsdatum</th>
                <td>{{ rechnung.rdatum }}</td>
            </tr>
            <tr>
                <th>Lieferdatum</th>
                <td>{{ rechnung.ldatum }}</td>
            </tr>
            <tr>
                <th>Fälligkeitsdatum</th>
                <td>
                    {% if rechnung.faellig and rechnung.gestellt %}
                    {% if not rechnung.erledigt %}
                    <span style="color: red;">
                        {% endif %}
                        {% endif %}
                        {{ rechnung.fdatum }}</span>
                </td>
            </tr>
            <tr>
                <th>Gestellt von</th>
                <td>{{ rechnung.ersteller.get_full_name }}</td>
            </tr>
            <tr>
                <th>Kategorie</th>
                <td>
                    <a href="{% url 'rechnung:kategorie_detail' rechnung.kategorie.id %}">{{ rechnung.kategorie }}</a>
                </td>
            </tr>
            <tr>
                <th>Einleitungstext</th>
                <td>{{ rechnung.einleitung }}</td>
            </tr>
        </table>
    </div>
    <div class="col-lg-{% if not mahnungen %}6{% else %}10{% endif %}">
        <h3>Posten
            {% if not rechnung.gestellt %}
            <a
                class="btn btn-secondary"
                href="{% url "rechnung:rechnung_posten_neu" rechnung.id %}"
            ><span class="bi bi-plus-circle-fill"></span> Neuer Posten</a>
            {% endif %}
        </h3>

        {% if rechnung.posten_set.count != 0 %}
        <br />
        <table class="table">
            <tr>
                <th class="text-end">Anzahl</th>
                <th>Bezeichnung</th>
                <th class="text-end">Einzelpreis</th>
                <th class="text-end">Mwst-Satz</th>
                <th class="text-end">Summe Netto</th>
            </tr>
            {% for posten in rechnung.posten_set.all %}
            <tr>
                <td class="align-content-end">{{ posten.anzahl }} </td>
                {% if rechnung.gestellt %}
                <td>{{ posten.name }}</td>
                {% else %}
                <td>
                    <a href="{% url 'rechnung:posten_aendern' posten.id %}">{{ posten.name }}</a>
                </td>
                {% endif %}
                <td class="align-content-end">{{ posten.einzelpreis }} €</td>
                <td class="align-content-end">{{ posten.get_mwst_display }}</td>
                <td class="align-content-end">{{ posten.summenettogerundet }} €</td>
            </tr>
            {% endfor %}
        </table>
        <table class="table">
            <tr>
                <th>Zwischensumme (netto):</th>
                <td class="align-content-end">{{ rechnung.zwischensumme }} €</td>
            </tr>
            <tr>
                <th>Zzgl. Mehrwertsteuer 7%</th>
                <td class="align-content-end">{{ rechnung.summe_mwst_7 }} €</td>
            </tr>
            <tr>
                <th>Zzgl. Mehrwertsteuer 19%</th>
                <td class="align-content-end">{{ rechnung.summe_mwst_19 }} €</td>
            </tr>
            <tr>
                <th>Gesamt (brutto):</th>
                <td class="align-content-end"><b>{{ rechnung.gesamtsumme }} €</b>
                </td>
            </tr>
        </table>
        {% else %}
        Es existieren momentan keine Posten für diese Rechnung.
        {% endif %}
    </div>
</div>
<form method="POST">{% csrf_token %}
    <a
        class="btn btn-secondary"
        href="{% url "rechnung:rechnungpdf" rechnung.id %}"
    ><span class="bi bi-cloud-arrow-down-fill"></span> Herunterladen</a>
    <a
        class="btn btn-secondary"
        href="{% url "rechnung:rechnung_duplizieren" rechnung.id %}"
    ><span class="bi bi-plus-circle"></span> Duplizieren</a>

    {% if rechnung.gestellt and not rechnung.erledigt %}
    <button
        class="btn btn-success"
        name="bezahlt"
        type="submit"
    ><span class="bi bi-credit-card-fill"></span> Bezahlt</button>
    {% elif not rechnung.gestellt and not rechnung.erledigt %}
    <button
        class="btn btn-warning"
        name="gestellt"
        type="submit"
    ><span class="bi bi-envelope-fill"></span> Gestellt</button>
    {% endif %}
</form>
{% endblock %}
